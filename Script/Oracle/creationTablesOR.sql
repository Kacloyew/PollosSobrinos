-- ============================================
-- SCRIPT COMPLETO ORACLE: Pollos Sobrinos
-- Incluye: DROP + CREATE + INSERT
-- ============================================

-- Deshabilitar restricciones temporalmente para evitar errores
BEGIN
    FOR c IN (SELECT constraint_name, table_name FROM user_constraints WHERE constraint_type = 'R') LOOP
        EXECUTE IMMEDIATE 'ALTER TABLE ' || c.table_name || ' DISABLE CONSTRAINT ' || c.constraint_name;
    END LOOP;
END;
/

-- ============================================
-- ELIMINAR TABLAS (si existen)
-- ============================================
DECLARE
    v_count INTEGER;
BEGIN
    -- Verificar y eliminar Pedidos
    SELECT COUNT(*) INTO v_count FROM user_tables WHERE table_name = 'PEDIDOS';
    IF v_count > 0 THEN
        EXECUTE IMMEDIATE 'DROP TABLE Pedidos CASCADE CONSTRAINTS';
        DBMS_OUTPUT.PUT_LINE('Tabla Pedidos eliminada');
    END IF;

    -- Verificar y eliminar Empleados
    SELECT COUNT(*) INTO v_count FROM user_tables WHERE table_name = 'EMPLEADOS';
    IF v_count > 0 THEN
        EXECUTE IMMEDIATE 'DROP TABLE Empleados CASCADE CONSTRAINTS';
        DBMS_OUTPUT.PUT_LINE('Tabla Empleados eliminada');
    END IF;

    -- Verificar y eliminar Clientes
    SELECT COUNT(*) INTO v_count FROM user_tables WHERE table_name = 'CLIENTES';
    IF v_count > 0 THEN
        EXECUTE IMMEDIATE 'DROP TABLE Clientes CASCADE CONSTRAINTS';
        DBMS_OUTPUT.PUT_LINE('Tabla Clientes eliminada');
    END IF;

    -- Verificar y eliminar Productos
    SELECT COUNT(*) INTO v_count FROM user_tables WHERE table_name = 'PRODUCTOS';
    IF v_count > 0 THEN
        EXECUTE IMMEDIATE 'DROP TABLE Productos CASCADE CONSTRAINTS';
        DBMS_OUTPUT.PUT_LINE('Tabla Productos eliminada');
    END IF;

    -- Verificar y eliminar Proveedores
    SELECT COUNT(*) INTO v_count FROM user_tables WHERE table_name = 'PROVEEDORES';
    IF v_count > 0 THEN
        EXECUTE IMMEDIATE 'DROP TABLE Proveedores CASCADE CONSTRAINTS';
        DBMS_OUTPUT.PUT_LINE('Tabla Proveedores eliminada');
    END IF;

    -- Verificar y eliminar Tiendas
    SELECT COUNT(*) INTO v_count FROM user_tables WHERE table_name = 'TIENDAS';
    IF v_count > 0 THEN
        EXECUTE IMMEDIATE 'DROP TABLE Tiendas CASCADE CONSTRAINTS';
        DBMS_OUTPUT.PUT_LINE('Tabla Tiendas eliminada');
    END IF;
END;
/

-- ============================================
-- CREAR TABLAS
-- ============================================

-- Tabla Tiendas
CREATE TABLE Tiendas (
    Tienda_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    Nombre_tienda VARCHAR2(100) NOT NULL,
    Direccion VARCHAR2(255),
    Telefono VARCHAR2(20),
    CorreoElectronico VARCHAR2(100)
);

-- Tabla Proveedores
CREATE TABLE Proveedores (
    Proveedor_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    Nombre VARCHAR2(100) NOT NULL,
    NIF_NIE_CIF VARCHAR2(20) NOT NULL UNIQUE,
    Telefono VARCHAR2(20),
    CorreoElectronico VARCHAR2(100),
    Direccion VARCHAR2(255),
    Tienda_ID NUMBER
);

-- Tabla Productos
CREATE TABLE Productos (
    Producto_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    Nombre VARCHAR2(100) NOT NULL,
    Precio NUMBER(10,2) NOT NULL,
    Stock NUMBER DEFAULT 0,
    Proveedor_ID NUMBER
);

-- Tabla Clientes
CREATE TABLE Clientes (
    Cliente_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    Nombre VARCHAR2(50) NOT NULL,
    Apellido VARCHAR2(50) NOT NULL,
    NIF_NIE VARCHAR2(20) NOT NULL UNIQUE,
    Telefono VARCHAR2(20),
    CorreoElectronico VARCHAR2(100),
    Tienda_ID NUMBER
);

-- Tabla Empleados
CREATE TABLE Empleados (
    Empleado_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    Nombre VARCHAR2(50) NOT NULL,
    Apellido VARCHAR2(50) NOT NULL,
    NIF_NIE VARCHAR2(20) NOT NULL UNIQUE,
    Telefono VARCHAR2(20),
    CorreoElectronico VARCHAR2(100),
    Puesto VARCHAR2(50),
    Salario NUMBER(10,2),
    Tienda_ID NUMBER
);

-- Tabla Pedidos
CREATE TABLE Pedidos (
    Pedido_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    Empleado_ID NUMBER,
    Tienda_ID NUMBER,
    Cliente_ID NUMBER,
    Producto_ID NUMBER,
    Fecha_Pedido TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    Cantidad NUMBER DEFAULT 1
);

-- ============================================
-- AGREGAR RESTRICCIONES (FOREIGN KEYS)
-- ============================================

-- Proveedores -> Tiendas
ALTER TABLE Proveedores
ADD CONSTRAINT fk_proveedor_tienda
FOREIGN KEY (Tienda_ID) REFERENCES Tiendas(Tienda_ID)
ON DELETE SET NULL;

-- Productos -> Proveedores
ALTER TABLE Productos
ADD CONSTRAINT fk_producto_proveedor
FOREIGN KEY (Proveedor_ID) REFERENCES Proveedores(Proveedor_ID)
ON DELETE SET NULL;

-- Clientes -> Tiendas
ALTER TABLE Clientes
ADD CONSTRAINT fk_cliente_tienda
FOREIGN KEY (Tienda_ID) REFERENCES Tiendas(Tienda_ID)
ON DELETE SET NULL;

-- Empleados -> Tiendas
ALTER TABLE Empleados
ADD CONSTRAINT fk_empleado_tienda
FOREIGN KEY (Tienda_ID) REFERENCES Tiendas(Tienda_ID)
ON DELETE SET NULL;

-- Pedidos -> Empleados
ALTER TABLE Pedidos
ADD CONSTRAINT fk_pedido_empleado
FOREIGN KEY (Empleado_ID) REFERENCES Empleados(Empleado_ID)
ON DELETE SET NULL;

-- Pedidos -> Tiendas
ALTER TABLE Pedidos
ADD CONSTRAINT fk_pedido_tienda
FOREIGN KEY (Tienda_ID) REFERENCES Tiendas(Tienda_ID)
ON DELETE SET NULL;

-- Pedidos -> Clientes
ALTER TABLE Pedidos
ADD CONSTRAINT fk_pedido_cliente
FOREIGN KEY (Cliente_ID) REFERENCES Clientes(Cliente_ID)
ON DELETE SET NULL;

-- Pedidos -> Productos
ALTER TABLE Pedidos
ADD CONSTRAINT fk_pedido_producto
FOREIGN KEY (Producto_ID) REFERENCES Productos(Producto_ID)
ON DELETE SET NULL;

-- ============================================
-- INSERTAR DATOS
-- ============================================

-- Insertar Tiendas
INSERT INTO Tiendas (Tienda_ID, Nombre_tienda, Direccion, Telefono, CorreoElectronico)
VALUES (1, 'Pollos Sobrinos Centro', 'Calle Mayor 123, Madrid', '910123456', 'centro@pollossobrinos.com');

INSERT INTO Tiendas (Tienda_ID, Nombre_tienda, Direccion, Telefono, CorreoElectronico)
VALUES (2, 'Pollos Sobrinos Norte', 'Avenida Norte 45, Barcelona', '932987654', 'norte@pollossobrinos.com');

-- Insertar Proveedores
INSERT INTO Proveedores (Proveedor_ID, Nombre, NIF_NIE_CIF, Telefono, CorreoElectronico, Direccion, Tienda_ID)
VALUES (1, 'Proveedor Pollos S.L.', 'A12345678', '912345678', 'info@proveedorpollos.com', 'Polígono Industrial 1, Madrid', 1);

INSERT INTO Proveedores (Proveedor_ID, Nombre, NIF_NIE_CIF, Telefono, CorreoElectronico, Direccion, Tienda_ID)
VALUES (2, 'Distribuidora Carnes Norte', 'B87654321', '934567890', 'ventas@carnesnorte.com', 'Calle Industria 45, Barcelona', 2);

INSERT INTO Proveedores (Proveedor_ID, Nombre, NIF_NIE_CIF, Telefono, CorreoElectronico, Direccion, Tienda_ID)
VALUES (6, 'Panecillos María S.L', 'B2156899', '933654710', 'panes.maria@gmail.com', 'Carrer del Tosqué', 2);

INSERT INTO Proveedores (Proveedor_ID, Nombre, NIF_NIE_CIF, Telefono, CorreoElectronico, Direccion, Tienda_ID)
VALUES (7, 'Productos Agricolas S.L', 'B156324789', '9123456712', 'info@productosagricolas.com', 'calle falsa 124', 1);

INSERT INTO Proveedores (Proveedor_ID, Nombre, NIF_NIE_CIF, Telefono, CorreoElectronico, Direccion, Tienda_ID)
VALUES (8, 'Productos Agricolas S.L', 'B156324788', '9123456712', 'info@productosagricolas.com', 'calle falsa 124', 2);

-- Insertar Productos
INSERT INTO Productos (Producto_ID, Nombre, Precio, Stock, Proveedor_ID)
VALUES (9, 'Pollo Entero', 12.50, 50, 1);

INSERT INTO Productos (Producto_ID, Nombre, Precio, Stock, Proveedor_ID)
VALUES (10, 'Alitas de Pollo', 8.75, 100, 1);

INSERT INTO Productos (Producto_ID, Nombre, Precio, Stock, Proveedor_ID)
VALUES (11, 'Hamburguesa de Pollo', 4.50, 200, 2);

INSERT INTO Productos (Producto_ID, Nombre, Precio, Stock, Proveedor_ID)
VALUES (12, 'Pechuga de Pollo', 9.90, 80, 2);

INSERT INTO Productos (Producto_ID, Nombre, Precio, Stock, Proveedor_ID)
VALUES (13, 'Muslos de Pollo', 6.25, 120, 1);

INSERT INTO Productos (Producto_ID, Nombre, Precio, Stock, Proveedor_ID)
VALUES (14, 'Croquetas de Pollo', 5.80, 180, 1);

INSERT INTO Productos (Producto_ID, Nombre, Precio, Stock, Proveedor_ID)
VALUES (15, 'Alas BBQ Preparadas', 9.40, 75, 2);

INSERT INTO Productos (Producto_ID, Nombre, Precio, Stock, Proveedor_ID)
VALUES (16, 'Salchichas de Pollo', 4.20, 150, 2);

INSERT INTO Productos (Producto_ID, Nombre, Precio, Stock, Proveedor_ID)
VALUES (17, 'Nuggets de Pollo', 6.80, 250, 1);

INSERT INTO Productos (Producto_ID, Nombre, Precio, Stock, Proveedor_ID)
VALUES (18, 'Pollo Troceado', 8.30, 90, 2);

-- Insertar Clientes
INSERT INTO Clientes (Cliente_ID, Nombre, Apellido, NIF_NIE, Telefono, CorreoElectronico, Tienda_ID)
VALUES (1, 'María', 'Rodríguez', '22334455D', '644556677', 'maria.rodriguez@gmail.com', 1);

INSERT INTO Clientes (Cliente_ID, Nombre, Apellido, NIF_NIE, Telefono, CorreoElectronico, Tienda_ID)
VALUES (2, 'Javier', 'Fernández', '33445566E', '655667788', 'javier.fernandez@hotmail.com', 2);

INSERT INTO Clientes (Cliente_ID, Nombre, Apellido, NIF_NIE, Telefono, CorreoElectronico, Tienda_ID)
VALUES (3, 'Sofía', 'García', '44556677F', '666778899', 'sofia.garcia@yahoo.com', 1);

INSERT INTO Clientes (Cliente_ID, Nombre, Apellido, NIF_NIE, Telefono, CorreoElectronico, Tienda_ID)
VALUES (4, 'Juan', 'Ramón', '54863210Y', '646598725', 'juan.ramon@gmail.com', 2);

INSERT INTO Clientes (Cliente_ID, Nombre, Apellido, NIF_NIE, Telefono, CorreoElectronico, Tienda_ID)
VALUES (5, 'África', 'Lorca', '87413210V', '647852634', 'africa.lorca@gmail.com', 2);

-- Insertar Empleados
INSERT INTO Empleados (Empleado_ID, Nombre, Apellido, NIF_NIE, Telefono, CorreoElectronico, Puesto, Salario, Tienda_ID)
VALUES (1, 'Carlos', 'Gómez', '12345678A', '611223344', 'carlos.gomez@pollossobrinos.com', 'Gerente', 2800.00, 1);

INSERT INTO Empleados (Empleado_ID, Nombre, Apellido, NIF_NIE, Telefono, CorreoElectronico, Puesto, Salario, Tienda_ID)
VALUES (2, 'Ana', 'López', '87654321B', '622334455', 'ana.lopez@pollossobrinos.com', 'Cajera', 1800.00, 1);

INSERT INTO Empleados (Empleado_ID, Nombre, Apellido, NIF_NIE, Telefono, CorreoElectronico, Puesto, Salario, Tienda_ID)
VALUES (3, 'Luis', 'Martínez', '11223344C', '633445566', 'luis.martinez@pollossobrinos.com', 'Cocinero', 2000.00, 2);

INSERT INTO Empleados (Empleado_ID, Nombre, Apellido, NIF_NIE, Telefono, CorreoElectronico, Puesto, Salario, Tienda_ID)
VALUES (4, 'Sandra', 'Sánchez', '94562145Q', '647856111', 'sandra.sanchez@gmail.com', 'cocinero', 2000.00, 1);

INSERT INTO Empleados (Empleado_ID, Nombre, Apellido, NIF_NIE, Telefono, CorreoElectronico, Puesto, Salario, Tienda_ID)
VALUES (5, 'Hugo', 'Diaz', '74532169P', '615645893', 'hugo.diaz@gmail.com', 'cajero', 1800.00, 2);

INSERT INTO Empleados (Empleado_ID, Nombre, Apellido, NIF_NIE, Telefono, CorreoElectronico, Puesto, Salario, Tienda_ID)
VALUES (6, 'Jesus', 'Gonzalez', '47852163N', '657148723', 'jesus.gonzalez@gmail.com', 'Gerente', 2800.00, 2);

-- ============================================
-- VERIFICAR INSERCIONES
-- ============================================
BEGIN
    DBMS_OUTPUT.PUT_LINE('================================');
    DBMS_OUTPUT.PUT_LINE('RESUMEN DE INSERCIONES:');
    DBMS_OUTPUT.PUT_LINE('================================');

    DECLARE
        v_count NUMBER;
    BEGIN
        SELECT COUNT(*) INTO v_count FROM Tiendas;
        DBMS_OUTPUT.PUT_LINE('Tiendas insertadas: ' || v_count);

        SELECT COUNT(*) INTO v_count FROM Proveedores;
        DBMS_OUTPUT.PUT_LINE('Proveedores insertados: ' || v_count);

        SELECT COUNT(*) INTO v_count FROM Productos;
        DBMS_OUTPUT.PUT_LINE('Productos insertados: ' || v_count);

        SELECT COUNT(*) INTO v_count FROM Clientes;
        DBMS_OUTPUT.PUT_LINE('Clientes insertados: ' || v_count);

        SELECT COUNT(*) INTO v_count FROM Empleados;
        DBMS_OUTPUT.PUT_LINE('Empleados insertados: ' || v_count);
    END;

    DBMS_OUTPUT.PUT_LINE('================================');
    DBMS_OUTPUT.PUT_LINE('BASE DE DATOS INICIALIZADA');
    DBMS_OUTPUT.PUT_LINE('================================');
END;
/

-- ============================================
-- HABILITAR RESTRICCIONES Y CONFIRMAR
-- ============================================
BEGIN
    FOR c IN (SELECT constraint_name, table_name FROM user_constraints WHERE constraint_type = 'R') LOOP
        BEGIN
            EXECUTE IMMEDIATE 'ALTER TABLE ' || c.table_name || ' ENABLE CONSTRAINT ' || c.constraint_name;
        EXCEPTION
            WHEN OTHERS THEN
                DBMS_OUTPUT.PUT_LINE('Error habilitando ' || c.constraint_name || ': ' || SQLERRM);
        END;
    END LOOP;
END;
/

-- Confirmar todos los cambios
COMMIT;

-- Mensaje final
PROMPT *******************************************************
PROMPT * Script ejecutado correctamente!
PROMPT * Base de datos "Pollos Sobrinos" creada e inicializada
PROMPT * Tablas: 6
PROMPT * Registros insertados: 31
PROMPT *******************************************************